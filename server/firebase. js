/**
 * firebase.js
 * Initializes firebase-admin if a service account is provided via env.
 * Exports: { enabled: boolean, db: firestore|null }
 *
 * Provide FIREBASE_SERVICE_ACCOUNT as JSON string OR base64-encoded JSON (FIREBASE_SERVICE_ACCOUNT_B64).
 */

const admin = require('firebase-admin');

let db = null;
let enabled = false;

try {
  const b64 = process.env.FIREBASE_SERVICE_ACCOUNT_B64;
  let sa = process.env.FIREBASE_SERVICE_ACCOUNT || null;
  if (!sa && b64) {
    const json = Buffer.from(b64, 'base64').toString('utf8');
    sa = json;
  }

  if (sa) {
    const serviceAccount = JSON.parse(sa);
    admin.initializeApp({
      credential: admin.credential.cert(serviceAccount)
    });
    db = admin.firestore();
    enabled = true;
    console.log('✅ Firestore enabled (firebase-admin initialized).');
  } else {
    console.log('⚠️ No FIREBASE_SERVICE_ACCOUNT provided — running in in-memory mode.');
  }
} catch (err) {
  console.error('❌ Failed to initialize firebase-admin:', err.message);
  enabled = false;
  db = null;
}

module.exports = { enabled, db };
